<!doctype html><html lang=en><style>﻿html,body,div,form,fieldset,legend,label,h1{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0}th,td{text-align:left;vertical-align:top}h1,h2,h3,h4,h5,h6,th,td,caption{font-weight:400}img{border:0;max-width:100%}h1{font-size:1.87em}h2{font-size:1.2em;margin-bottom:10px;margin-top:0}h3{margin-top:50px}body{background-color:#fff;color:rgba(0,0,0,.8);font-family:medium-content-serif-font,Georgia,Cambria,times new roman,Times,serif;-moz-font-feature-settings:"liga" on;font-feature-settings:"liga" on;font-size:1.25em;-moz-osx-font-smoothing:grayscale;font-style:normal;font-weight:400;letter-spacing:-.003em;line-height:1.58;text-rendering:optimizeLegibility}article{margin-top:44px}pre{-moz-font-feature-settings:"liga" off;font-feature-settings:"liga" off;font-size:.92em;-moz-osx-font-smoothing:auto;-webkit-font-smoothing:subpixel-antialiased;padding:20px;overflow:auto}::-moz-selection{background:#000;color:#fff}::selection{background:#000;color:#fff}body{margin-top:8%}header{font-size:.78em;margin:0 auto 2em;max-width:220px;text-align:center}a:link,a:visited,a:hover,a:active{color:#af403c;text-decoration:none}a:hover{text-decoration:underline}nav{text-align:center}nav ul{display:inline-block;text-align:initial;padding-left:0}nav li:not(:first-child):before{content:" · "}nav li{list-style:none;display:inline}.logo{background-size:cover;display:inline-block;height:150px;width:171px}.published-date{color:#888;font-size:.8em}blockquote{border-left:4px solid #ededee;font-style:italic;margin:4px 10px;padding:3px 20px}code{background-color:#f9f9fa;border:1px solid #ededee;border-radius:6px;display:inline-block;font-family:courier new,courier,monospace;-moz-font-feature-settings:"liga" off;font-feature-settings:"liga" off;font-size:16px;-moz-osx-font-smoothing:auto;-webkit-font-smoothing:subpixel-antialiased;max-width:100%;overflow-x:auto;padding:0 5px;vertical-align:middle;word-wrap:normal;box-shadow:0 1px 1px rgba(0,0,0,.125)}.button{background-color:#af403c;border-radius:10px;color:#fff;margin:40px auto;padding:10px;text-align:center}.button:hover{background-color:red}.talk{margin-top:80px}.video-container{position:relative;padding-bottom:56.25%;padding-top:30px;height:0;overflow:hidden;margin-bottom:40px}.video-container iframe,.video-container object,.video-container embed{position:absolute;top:0;left:0;width:100%;height:100%}figure{font-size:.9em;font-style:italic;margin:0 0 40px;padding:0;text-align:center;text-indent:0}figcaption{margin-top:10px}.loader{position:relative;overflow:hidden;width:auto}.loader object{position:absolute}.loader img,.loader object{display:block;top:0;left:0;width:100%}object{position:relative;float:left;display:block}object::after{position:absolute;top:0;left:0;display:block;width:1e3px;height:1e3px;content:"";background:#efefef}.frozen{-webkit-filter:blur(8px);-moz-filter:blur(8px);-o-filter:blur(8px);-ms-filter:blur(8px);filter:blur(8px);transform:scale(1.04);animation:.2s ease-in .4s 1 forwards fade;width:100%}@keyframes fade{0%{opacity:1}100%{opacity:0}}@media(max-width:520px){body{padding:0 20px}pre{font-size:.85em;padding:5px}h1{font-size:1.6em}}@media(min-width:520px){body{margin:10% auto 0;margin-top:120px;width:480px}h1{font-size:1.6em}}@media(min-width:1024px){body{width:850px}header{float:left;width:210px}main,footer{margin-left:260px;margin-bottom:40px}}footer{margin-bottom:40px}.links{list-style:none;display:inline}.field{padding:10px;font-size:.8em}.email{width:300px}.submit{border:0;padding:12px;background-color:#eee}</style><link rel=dns-prefetch href=//www.google-analytics.com/><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=m2llJQPQq8"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=m2llJQPQq8"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=m2llJQPQq8"><link rel=manifest href="data:application/manifest+json;base64,eyJzaG9ydF9uYW1lIjoiRW5kbGVyIiwiaWNvbnMiOlt7InNyYyI6Ii9hbmRyb2lkLWNocm9tZS0xOTJ4MTkyLnBuZz92PW0ybGxKUVBRcTgiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiIvYW5kcm9pZC1jaHJvbWUtNTEyeDUxMi5wbmc/dj1tMmxsSlFQUXE4Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0="><link rel=mask-icon href="/safari-pinned-tab.svg?v=m2llJQPQq8" color=#5bbad5><link rel="shortcut icon" href="/favicon.ico?v=m2llJQPQq8"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#ffffff><meta property=og:title content="Launching a URL Shortener in Rust using Rocket"><meta property=og:type content=website><meta property=og:description content="One common Systems Design task in interviews..."><meta property=og:url content=https://matthias-endler.de/2017/rust-url-shortener><meta property=og:image content=https://matthias-endler.de/img/social/default.png><meta name=twitter:title content="Launching a URL Shortener in Rust using Rocket"><meta name=twitter:description content="One common Systems Design task in interviews..."><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@matthiasendler><meta name=twitter:creator content=@matthiasendler><meta name=twitter:image content=https://matthias-endler.de/img/social/default.png><title>Launching a URL Shortener in Rust using Rocket | Matthias Endler</title><meta name=author content="Matthias Endler"><meta name=description content="Personal website of Matthias Endler, a Software Engineer interested in low-level programming and backend development. PHP, Python, Go, Rust."><header><a class=logo href=/><img alt=Home src=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3OTAuMjMgNjkyLjYxIj48Y2lyY2xlIGN4PSI0MTMuMjQiIGN5PSIyMjcuNyIgcj0iMjE5LjY4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMTYuMDMiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCIvPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgc3Ryb2tlPSIjYTE2MjAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCI+PHBhdGggZmlsbD0iIzMzMWYwMCIgc3Ryb2tlLXdpZHRoPSIxLjk3IiBkPSJNNDgzLjc1IDI2NS43NGwtNjcuMDcgNDAuMTQtNzQuMjMtMzkuNTMgMTQxLjMtLjZ6IiBzdHlsZT0ibGluZS1oZWlnaHQ6MTI1JSIvPjxwYXRoIGZpbGw9IiNlZmJhMDAiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTQ4Ni42NSAyNjUuOTJsLTcwLjIgMzQuMDItNzYuOS0zMy45IDE0Ny4xLS4xMnoiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIi8+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2OC42NCAyLjkxNCkgc2NhbGUoLjY1Nzk1KSIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIj48ZWxsaXBzZSBjeD0iLTYwOC43NSIgY3k9Ii0xNjMuMTQiIHRyYW5zZm9ybT0ibWF0cml4KDEuMjQ4OTcgLS4xMTM3IC4xMDcgMS4xNzUxNyAxMDk1Ljg3IDQ2Ni43KSIgcng9IjI1LjI1IiByeT0iMjgiLz48ZWxsaXBzZSBjeD0iMzMxLjM2IiBjeT0iMzQ3Ljk5IiBmaWxsPSIjZmZmIiB0cmFuc2Zvcm09Im1hdHJpeCguNTIyMTMgMCAwIC41NDc0NSAxNTguNzU3IDEzNi40MzIpIiByeD0iMTUuMTUiIHJ5PSIxNy4wNCIvPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjguNjQgMi45MTQpIHNjYWxlKC42NTc5NSkiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCI+PGVsbGlwc2UgY3g9Ii02MDguNzUiIGN5PSItMTYzLjE0IiB0cmFuc2Zvcm09Im1hdHJpeCgxLjI0ODk3IC0uMTEzNyAuMTA3IDEuMTc1MTcgMTIwMy4yIDQ2Ny42NDYpIiByeD0iMjUuMjUiIHJ5PSIyOCIvPjxlbGxpcHNlIGN4PSIzMzEuMzYiIGN5PSIzNDcuOTkiIGZpbGw9IiNmZmYiIHRyYW5zZm9ybT0ibWF0cml4KC41MjIxMyAwIDAgLjU0NzQ1IDI2NS4zNTggMTM2Ljk5MykiIHJ4PSIxNS4xNSIgcnk9IjE3LjA0Ii8+PC9nPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgc3Ryb2tlPSIjMDAwIj48cGF0aCBkPSJNMzY2LjQgMTAwLjY0YzE4LjU0LTExLjA1IDM2LjU0LTIyLjU3IDQ2Ljk0LTQwLjczIDEuMzUgMTIuMy0uMSAyOC41LTEwLjg2IDQzLjUiLz48cGF0aCBkPSJNMzg5LjQ0IDEwMC42NGMxOC41NC0xMS4wNSAzNi41NC0yMi41NyA0Ni45NC00MC43MyAxLjM1IDEyLjMtLjEgMjguNS0xMC44NiA0My41Ii8+PHBhdGggZD0iTTQxMi40OCAxMDAuNjRDNDMxLjAyIDg5LjYgNDQ5IDc4LjA3IDQ1OS40MiA1OS45YzEuMzUgMTIuMy0uMSAyOC40NC0xMC44NiA0My40NiIvPjwvZz48cGF0aCBkPSJNNDA5LjI0IDg3LjA1Yy04MS44NS4yNy0xNTYuNDQgMTA0LjQzLTE4MC40OCAyMTYuNDZhMTk5LjYgMTk5LjYuMCAwIDAgNTEuODMgNzMuMWM3LjktMTU3LjkgNDQuNy0yNjYuOSAxMTIuNS0yMDcuOCAxMC4xIDguOSAxNS4yIDEyLjkgMjAuMSAxMi42IDQuOS4zIDEwLTMuOCAyMC4xLTEyLjYgNjcuNy01OS4xIDEwNC42IDUwIDExMi41IDIwNy44YTE5OS42IDE5OS42LjAgMCAwIDUxLjgtNzIuOWMtMjQtMTEyLTk4LjYtMjE2LjMtMTgwLjUtMjE2LjUtMS4zOC4wLTIuNy4xLTQgLjEtMS4zOC4wLTIuNy0uMS00LS4xeiIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0iIzk1OTU5NSIgZD0iTTEzMS4zIDY5Mi42aDExLjRsLTIwLjkyLTEzOC4zSDEwOS41TDg4LjYgNjkyLjZIMWUybDUuODgtNDUuOGgxOS4zNnptLTI0LjItNTQuOTYgOC40Ni02NC4zIDguNDcgNjQuM3ptODIuMDUtODMuMzRIMTQ4djEwLjczaDE0Ljg3VjY5Mi42aDExLjRWNTY1LjA0aDE0Ljg4eiIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSU7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjonRXZlciBBZnRlciwgTm9ybWFsJzt0ZXh0LWFsaWduOnN0YXJ0IiBmb250LWZhbWlseT0iRXZlciBBZnRlciIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCIvPjxwYXRoIGZpbGw9IiM5NTk1OTUiIGQ9Ik0yMjguNjUgNTU0LjNIMTg3LjV2MTAuNzNoMTQuODdWNjkyLjZoMTEuNFY1NjUuMDRoMTQuODh6bTQ0LjkuMHY2MS4zOEgyNDUuMlY1NTQuM2gtMTEuNDJ2MTM4LjNoMTEuNHYtNjYuMzhoMjguMzZ2NjYuNGgxMS4yM1Y1NTQuM3ptMzcuOCAxMzguM2gtMTEuNFY1NTQuM2gxMS40em01Ny42NS4waDExLjRsLTIwLjkyLTEzOC4zSDM0Ny4ybC0yMC45IDEzOC4zaDExLjRsNS44Ny00NS44aDE5LjM2em0tMjQuMjItNTQuOTYgOC40Ny02NC4zIDguNDcgNjQuM3oiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246J0V2ZXIgQWZ0ZXIsIE5vcm1hbCc7dGV4dC1hbGlnbjpzdGFydCIgZm9udC1mYW1pbHk9IkV2ZXIgQWZ0ZXIiIGxldHRlci1zcGFjaW5nPSIwIiB3b3JkLXNwYWNpbmc9IjAiLz48cGF0aCBkPSJNNTE3LjI2IDU2NS4wM1Y1NTQuM2gtMzEuNjR2MTM4LjNoMzEuNjR2LTEwLjdoLTIwLjIzdi01NS43aDE4Ljg1di0xMC41NGgtMTguODVWNTY1em0xMS4yNC0xMC43M3YxMzguM2gxMS4zNVY1NTQuM0g1MjguNXptMzkuNzYuMHY1MS44N2wtLjEtLjE3djIwLjc1bC4xLjE3djY1LjdoMTEuMjRWNTU0LjNoLTExLjI0em00MC4yNC4waC0xMy44djEzOC4zaDEzLjgzcTIyLjMuMCAyOS41Ny0yMi40NiA0LjE1LTEzLjMyIDQuMTUtNDYuNjh0LTQuMTUtNDYuNjdxLTcuMjYtMjIuNS0yOS41Ni0yMi41em0tMS4yIDEyNy42aC0xLjJWNTY1LjAyaDEuMnExNS43My4wIDIwLjU3IDE4LjUgMy4xIDExLjA2IDMuMSAzOS45My4wIDI4Ljg3LTMuMSAzOS45My00Ljg0IDE4LjUtMjAuNTcgMTguNXptNjAuMjQuMFY1NTQuM2gtMTEuNHYxMzguM2gzMS42MnYtMTAuN3ptNjIuMS0xMTYuODdWNTU0LjNINjk4djEzOC4zaDMxLjYzdi0xMC43SDcwOS40di01NS43aDE4Ljg1di0xMC41NEg3MDkuNFY1NjV6bTYwLjUgMTI3LjU3cS0xNC4xNy0zNy0yMC43NC03Mi4yNSAxNC4xNy0xMC4zNyAxNC4xNy0zMy44OC4wLTMyLjE2LTI3LjQ4LTMyLjE2aC0xNS4zdjEzOC4zaDExLjR2LTY1cTIuMi0uNSA2LjktMiA3IDMzLjQgMTguMyA2Ny4xem0tMzcuODYtNzguNDd2LTQ5LjFoMi42cTEwLjU0LjAgMTQuNyA1Ljg4IDMuMjcgNC43IDMuMjcgMTUuNi4wIDE1LjgtOC4xMiAyMy40LTUuMiA0LjktMTAuMiA0LjktMS4zOC4wLTIuMjUtLjV6IiBzdHlsZT0ibGluZS1oZWlnaHQ6MTI1JTstaW5rc2NhcGUtZm9udC1zcGVjaWZpY2F0aW9uOidFdmVyIEFmdGVyLCBOb3JtYWwnO3RleHQtYWxpZ246c3RhcnQiIGZvbnQtZmFtaWx5PSJFdmVyIEFmdGVyIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEwIiBkPSJNNTM1LjA2IDU1NS43MmwzOCAxMzUuNTQiLz48cGF0aCBmaWxsPSIjOTU5NTk1IiBkPSJNLjEgNTU0LjZ2MTM4aDExLjM4VjU3NS42NWM2LjYgMTIuNyAxMy43OCAyNS45IDE5LjY3IDM2Ljc4bDUuNyAxMCAuMDItLjAydi4xbDUuNzItMTBjNi41LTEyIDEzLjUtMjUuMiAxOS43LTM2Ljh2MTE2LjloMTEuMnYtMTM4SDYyLjNDNTUgNTY4IDQ3LjUgNTgyIDQwLjggNTk0LjRsLTQgNy40NWMtOS4xLTE3LjA1LTE3LjMtMzIuMDctMjUuNC00Ny4yM3oiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246J0V2ZXIgQWZ0ZXIsIE5vcm1hbCc7dGV4dC1hbGlnbjpzdGFydCIgZm9udC1zaXplPSIxNzIuNTIiIGZvbnQtZmFtaWx5PSJFdmVyIEFmdGVyIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0iIzk1OTU5NSIgZD0iTTM5OC44NCA2OTEuNjZjLTMuNzItMS4zMy04Ljk2LTUtMTEuNzYtOC4yLTEuNC0xLjYtMi41LTMuMjUtMi41NC0zLjYgNC4yMy02LjA1IDQuNDItNi4zMiA1LjMtNy40NSAzLjMgMy40IDYuNyA2LjggMTAuOSA5LjEgNC45OCAxLjggMTEuMjQgMi4xIDE1LjMyLS4zIDUuNTItMy4zIDguNjItOC44IDkuNjctMTcuMyAxLjQ2LTExLjctMi42NS0yMi41LTEzLjI1LTM0LjgtMi45LTMuNC03LjEzLTguMy05LjM4LTEwLjktNC44Ni01LjYtMTAtMTMuNC0xMS43Ny0xOC41LTQuMy0xMi41LTMuODctMjEuMy0uNjYtMzAuMiAyLjEyLTUuODMgNC45LTkuNiA5LjA4LTEyLjIgOC4yNi01LjE0IDE5LjI4LTQuMjQgMjcuMzYgMi4yNS45LjY4IDEuNyAxLjQ0IDIuNSAyLjU3LS40Ljc3LTMuNyA4Ljc3LTQuMyA4Ljc3LS44LS42Ni0uOC0uNi0xLjYtMS4zLS43LS43LTIuNy0yLjEtNC40LTMuMTQtNC40LTIuMS04LjUtMy4xLTEyLjktLjctNi4xIDMuNDQtOS4yIDExLjctNy45IDIxLjQgMS4xIDguMzQgNC41IDE0IDE3LjkgMjkuNSAxMy4wOCAxNS4yIDE2Ljk1IDIyLjMgMTguOSAzNC42My45IDUuNy45IDEwLjA0LjAgMTYuNi0xLjY1IDEyLjMzLTcuMiAyMC41LTE2LjIgMjMuOTYtMy4zIDEuMy0xNi40NSAxLjMtMjAuMDMuMDR6Ii8+PC9zdmc+></a><p>Backend Engineer at trivago. Likes just-in-time compilers and hot chocolate. <a href=/about>About me.</a><nav><ul><li><a href=/>Home</a><li><a target=_blank rel=noopener href=https://twitter.com/matthiasendler>Twitter</a><li><a target=_blank rel=noopener href=https://feedly.com/i/subscription/feed/https://matthias-endler.de/rss.xml>RSS</a></ul></nav></header><main role=main><div class=published-date><i>Published on 9th of April 2017</i></div><h1>Launching a URL Shortener in Rust using Rocket</h1><p>One common Systems Design task in interviews is to sketch the software architecture of a URL shortener (a <a target=_blank rel=noopener href=https://bit.ly>bit.ly</a> clone, so to say).
Since I was playing around with Rocket, why not give it a try?<div class=loader><object data=/img/posts/2017/rocket.svg>A rocket travelling through space"</object>
<img class=frozen src=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAKCAMAAABcxfTLAAABO1BMVEX////KysrJyMbHx8fJyL/MybrVzaLKyL7LycLKycXHx8b39/f++Pk1MjJZVEUuLi4zMi6AdjDv1jL43TKomTE/PC8zMjGAZznjsVHqvGX///798vO2l5s2MjJSSy7ZxjH00jDapCXtxStcVC+4ijnUlTrmr0b78+Z9XWCcXVs7OC7OvDHpsyi1Qx7qxCxPRyxFOSpgTi+/jTPYsWo2NDNSTEA3NjMxMS5yaTHTwTLkzzKNgTA9OS44NjDf39+JMyGSMx4xMS81NC87OS5kWzc9OjM5ODVsfWxidmNCQkJMNC5RMis5NTQ5NzQvLy83NjI9RUO52Z6E0dZAT1A4NTWZdmSedmSKblcwMC8+PDc9Pj6TxbqJwq4yMzLSx8DcqY/QnIPPysjOzs7Rz8r4+Pj+/v3Wwa7pzb/98etsScYgAAAAZUlEQVR42mNkYGQEYjD4xc74lZGHERVIMzJ+4gez3oiCSAYNxmfScNmzjAwmcM4lBv1DjAz2jIxfYYZ8BfK9GI/YMh6yB/NfA/khYNY2Bm8g+RDIjwPz/zOAANMcxlQgZwYDHAAACJcVTNx317sAAAAASUVORK5CYII></div><h3>Requirements</h3><p>A URL shortener has two main responsibilities:<ul><li>Create a shorter URL from a longer one (d'oh)<li>Redirect to the longer link when the short link is requested.</ul><p>Let's call our service <code>rust.ly</code> (<em>Hint, hint:</em> the domain is still available at the time of writing...).<p>First, we create a new Rust project:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>cargo new </span><span style=background-color:#eff1f5;color:#4f5b66>-</span><span style=background-color:#eff1f5;color:#4f5b66>-</span><span style=background-color:#eff1f5;color:#4f5b66>bin rustly
</span></pre><p>Next, we add Rocket to our <code>Cargo.toml</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#4f5b66>dependencies</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>rocket </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>0.2.4</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>rocket_codegen </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>0.2.4</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>Warning: Most likely you need to get the very newest Rocket version.
Otherwise, you might get some entertaining error messages. Check out the newest
version from <a target=_blank rel=noopener href=https://crates.io/crates/rocket>crates.io</a>.<p>Since Rocket requires cutting-edge Rust features, we need to use a recent nightly
build. <a target=_blank rel=noopener href=http://rustup.rs/>Rustup</a> provides a simple way to switch between stable and nightly.<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>rustup update </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66> rustup </span><span style=background-color:#bf616a;color:#eff1f5>override</span><span style=background-color:#eff1f5;color:#4f5b66> set nightly
</span></pre><h3>A first prototype</h3><p>Now we can start coding our little service.
Let's first write a simple &quot;hello world&quot; skeleton to get started.
Put this into <code>src/main.rs</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#![feature(plugin)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#![plugin(rocket_codegen)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>extern</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>crate</span><span style=background-color:#eff1f5;color:#4f5b66> rocket</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#[get(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/&lt;id&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>format!</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>⏩ You requested </span><span style=background-color:#eff1f5;color:#d08770>{}</span><span style=background-color:#eff1f5;color:#a3be8c>. Wonderful!</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> id</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#[get(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/&lt;url&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>url</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>format!</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>💾 You shortened </span><span style=background-color:#eff1f5;color:#d08770>{}</span><span style=background-color:#eff1f5;color:#a3be8c>. Magnificient!</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>main</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>ignite</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>mount</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>routes!</span><span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#4f5b66>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>mount</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/shorten</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>routes!</span><span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#4f5b66>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>launch</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>Under the hood, Rocket is doing some magic to enable this nice syntax.
More specifically, we use the <code>rocket_codegen</code> crate for that.
(It's implemented as a compiler plugin, which is also the reason why we need to use nightly Rust.)<p>In order to bring the rocket library into scope, we write <code>extern crate rocket;</code>.<p>We defined the two <em>routes</em> for our service. Both routes will respond to a <code>GET</code> request.<br>This is done by adding an <em>attribute</em> named <code>get</code> to a function.
The attribute can take additional arguments.
In our case, we define an <code>id</code> variable for the <code>lookup</code> endpoint and a <code>url</code> variable for the <code>shorten</code> endpoint.
Both variables are Unicode string slices. Since Rust has awesome Unicode support, we respond with a nice emoji just to show off. 🕶<p>Lastly, we need a main function which launches Rocket and mounts our two routes. This way, they become publicly available.
If you want to know even more about the in-depth details, I may refer you to the <a target=_blank rel=noopener href=https://rocket.rs/guide>official Rocket documentation</a>.<p>Let's check if we're on the right track by running the application.<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>cargo run
</span></pre><p>After some compiling, you should get some lovely startup output from Rocket:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>🔧  Configured </span><span style=background-color:#eff1f5;color:#b48ead>for</span><span style=background-color:#eff1f5;color:#4f5b66> development.
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> address</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> localhost
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> port</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>8000</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> log</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> normal
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> workers</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>8</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>🛰  Mounting </span><span style=background-color:#eff1f5;color:#4f5b66>&#39;</span><span style=background-color:#eff1f5;color:#a3be8c>/</span><span style=background-color:#eff1f5;color:#4f5b66>&#39;</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>GET</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>/</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>hash</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>🛰  Mounting </span><span style=background-color:#eff1f5;color:#4f5b66>&#39;</span><span style=background-color:#eff1f5;color:#4f5b66>/</span><span style=background-color:#eff1f5;color:#4f5b66>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>&#39;</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>GET</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>/</span><span style=background-color:#eff1f5;color:#4f5b66>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>/</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>🚀  Rocket has launched from http</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#a7adba>//</span><span style=background-color:#eff1f5;color:#a7adba>localhost:8000...
</span></pre><p>Sweet! Let's call our service.<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>&gt; curl localhost:8000/shorten/www.matthias-endler.de
</span><span style=background-color:#eff1f5;color:#4f5b66>💾 You shortened www.matthias-endler.de. Magnificient!
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>&gt; curl localhost:8000/www.matthias-endler.de
</span><span style=background-color:#eff1f5;color:#4f5b66>⏩ You requested www.matthias-endler.de. Wonderful!
</span></pre><p>So far so good.<h3>Data storage and lookup</h3><p>We need to keep the shortened URLs over many requests... but how?
In a production scenario, we could use some NoSQL data store like Redis for that.
Since the goal is to play with Rocket and learn some Rust, we will simply use an
in-memory store.<p>Rocket has a feature called <a target=_blank rel=noopener href=https://rocket.rs/guide/state/>managed state</a>.<p>In our case, we want to manage a <em>repository</em> of URLs.<p>First, let's create a file named <code>src/repository.rs</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>collections::</span><span style=background-color:#eff1f5;color:#4f5b66>HashMap</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>shortener::</span><span style=background-color:#eff1f5;color:#4f5b66>Shortener</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>struct</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>urls</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>HashMap</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>String, String</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>shortener</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> Shortener,
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>impl</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> Repository</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>Repository </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>urls</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>HashMap::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>shortener</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Shortener::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>url</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> id </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.shortener.</span><span style=background-color:#eff1f5;color:#96b5b4>next_id</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.urls.</span><span style=background-color:#eff1f5;color:#96b5b4>insert</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>id.</span><span style=background-color:#eff1f5;color:#96b5b4>to_string</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> url.</span><span style=background-color:#eff1f5;color:#96b5b4>to_string</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>id
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Option</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>String</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.urls.</span><span style=background-color:#eff1f5;color:#96b5b4>get</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>id</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>Within this module we first import the <code>HashMap</code> implementation from the standard library.
We also include <code>shortener::Shortener;</code>, which will help us to shorten the URLs in the next step. Don't worry too much about that for now.
By convention, we implement a <code>new()</code> method to create a new Repository struct with an empty <code>HashMap</code> and a new <code>Shortener</code>. Additionally, we have two methods, <code>store</code> and <code>lookup</code>.<p><code>store</code> takes a URL and writes it to our in-memory HashMap storage. It uses our yet to be defined shortener to create a unique id. It returns the shortened ID for the entry.
<code>lookup</code> gets a given ID from the storage and returns it as an <code>Option</code>. If the ID is found, the return value will be <code>Some(url)</code>, if there is no match it will return <code>None</code>.<p>Note that we convert the string slices (<code>&amp;str</code>) to <code>String</code> using the <code>to_string()</code> method. This way we don't need to deal with <a target=_blank rel=noopener href=https://doc.rust-lang.org/book/lifetimes.html>lifetimes</a>. As a beginner, don't think too hard about them.<h3>Advanced remarks (can safely be skipped)</h3><p>A seasoned (Rust) Programmer might do a few things differently here. Did you notice the tight coupling between the repository and the shortener? In a production system, <code>Repository</code> and <code>Shortener</code> might simply be concrete implementations of traits (which are a bit like interfaces in other languages, but more powerful). For example, <code>Repository</code> would implement <code>Cache</code> trait:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>trait</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Cache</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#a7adba>//</span><span style=background-color:#eff1f5;color:#a7adba> Store an entry and return an ID
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>data</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#a7adba>//</span><span style=background-color:#eff1f5;color:#a7adba> Look up a previously stored entry
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Option</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>String</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>This way we get a clear interface, and we can easily switch to a different implementation (e.g. a <code>RedisCache</code>). Also, we could have a <code>MockRepository</code> to simplify testing. Same for <code>Shortener</code>.<p>You might also want to use the <code>Into</code> trait to support both, <code>&amp;str</code> and <code>String</code> as a parameter of <code>store</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>store</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>T</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Into</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>String</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>url</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> T</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> id </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.shortener.</span><span style=background-color:#eff1f5;color:#96b5b4>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.urls.</span><span style=background-color:#eff1f5;color:#96b5b4>insert</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>id.</span><span style=background-color:#eff1f5;color:#96b5b4>to_owned</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> url.</span><span style=background-color:#eff1f5;color:#96b5b4>into</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>id
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>If you're curious about this, read <a target=_blank rel=noopener href=http://hermanradtke.com/2015/05/06/creating-a-rust-function-that-accepts-string-or-str.html>this article from Herman J. Radtke III</a>.
For now, let's keep it simple.<h3>Actually shortening URLs</h3><p>Let's implement the URL shortener itself.
You might be surprised how much was written about URL shortening <a target=_blank rel=noopener href=https://blog.codinghorror.com/url-shortening-hashes-in-practice/>all over the web</a>.
One common way is to create <a target=_blank rel=noopener href=http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener>short urls using base 62 conversion</a>.<p>After looking around some more, I found this sweet crate called <a target=_blank rel=noopener href=https://github.com/archer884/harsh>harsh</a>, which perfectly fits the bill.<p>To use <code>harsh</code>, we add it to the dependency section of our <code>Cargo.toml</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>harsh = &quot;0.1.2&quot;
</span></pre><p>Next, we add the crate to the top of to our <code>main.rs</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>extern crate harsh;
</span></pre><p>Let's create a new file named <code>src/shortener.rs</code> and write the following:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>harsh::</span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>Harsh</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> HarshBuilder</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>struct</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Shortener</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>u64</span><span style=background-color:#eff1f5;color:#4f5b66>,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>generator</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> Harsh,
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>impl</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Shortener</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> Shortener</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> harsh </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>HarshBuilder::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>init</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>Shortener </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>0</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>generator</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> harsh</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>next_id</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> String</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> hashed </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.generator.</span><span style=background-color:#eff1f5;color:#96b5b4>encode</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.id</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#bf616a>self</span><span style=background-color:#eff1f5;color:#4f5b66>.id </span><span style=background-color:#eff1f5;color:#4f5b66>+</span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>1</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>hashed
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>With <code>use harsh::{Harsh, HarshBuilder};</code> we bring the required structs into scope. Then we define our own <code>Shortener</code> struct, which wraps <code>Harsh</code>. It has two fields: <code>id</code> stores the next id for shortening. (Since there are no negative ids, we use an <a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/Integer_(computer_science)#Value_and_representation>unsigned integer</a> for that.) The other field is the <code>generator</code> itself, for which we use <code>Harsh</code>.
Using the <code>HarshBuilder</code> you can do a lot of fancy stuff, like setting a custom alphabet for the ids. For more info, check out the <a target=_blank rel=noopener href=https://github.com/archer884/harsh/>official docs</a>.
With <code>next_id</code> we retrieve a new <code>String</code> id for our URLs.<p>As you can see, we don't pass the URL to <code>next_id</code>. That means we actually don't shorten anything. We merely create a short, unique ID. That's because most hashing algorithms produce fairly <a target=_blank rel=noopener href=https://blog.codinghorror.com/url-shortening-hashes-in-practice/>long URLs</a> and having short URLs is the whole idea.<h3>Wiring it up</h3><p>So we are done with our shortener and the repository.
We need to adjust our <code>src/main.rs</code> again to use the two.<p>This is the point where it gets a little hairy.<p>I have to admit that I struggled a bit here.
Mainly because I was not used to multi-threaded request handling. In Python or
PHP you don't need to think about shared-mutable access.<p>Initially I had the following code in my <code>main.rs</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#[get(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/&lt;url&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>repo</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>State</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>url</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>repo.</span><span style=background-color:#eff1f5;color:#96b5b4>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>main</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>ignite</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>manage</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>Repository::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>mount</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/store</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>routes!</span><span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#4f5b66>store</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>launch</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p><a target=_blank rel=noopener href=https://rocket.rs/guide/state/>State</a> is the built-in way to save data across requests in Rocket. Just tell it what belongs to your application state with <code>manage()</code> and Rocket will automatically inject it into the routes.<p>But the compiler did not like that:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>error</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> cannot borrow immutable borrowed content </span><span style=background-color:#eff1f5;color:#4f5b66>as</span><span style=background-color:#eff1f5;color:#4f5b66> mutable
</span><span style=background-color:#eff1f5;color:#4f5b66>  </span><span style=background-color:#eff1f5;color:#4f5b66>-</span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> src</span><span style=background-color:#eff1f5;color:#4f5b66>/</span><span style=background-color:#eff1f5;color:#4f5b66>main.rs
</span><span style=background-color:#eff1f5;color:#4f5b66>   </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>   </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>     repo.</span><span style=background-color:#eff1f5;color:#96b5b4>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>   </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>     ^^^^ cannot borrow as mutable</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>What would happen if two requests wanted to modify our repository at the same time?
Rust prevented a race condition here!
Admittedly the error message could have been a bit more user-friendly, though.<p>Fortunately, Sergio Benitez helped me out on the <a target=_blank rel=noopener href=https://kiwiirc.com/client/irc.mozilla.org/#rocket>Rocket IRC channel</a> (thanks again!).
The solution was to put the repository behind a Mutex.<p>Here is the full <code>src/main.rs</code> in its entirety:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#![feature(plugin, custom_derive)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#![plugin(rocket_codegen)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>extern</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>crate</span><span style=background-color:#eff1f5;color:#4f5b66> rocket</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>extern</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>crate</span><span style=background-color:#eff1f5;color:#4f5b66> harsh</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>sync::</span><span style=background-color:#eff1f5;color:#4f5b66>RwLock</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>State</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>request::</span><span style=background-color:#eff1f5;color:#4f5b66>Form</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>response::</span><span style=background-color:#eff1f5;color:#4f5b66>Redirect</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>mod</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>repository</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>mod</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>shortener</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>repository::</span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#[derive(FromForm)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>struct</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Url</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>url</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> String,
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#[get(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/&lt;id&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>repo</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>State</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>RwLock</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>id</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Result</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>Redirect, </span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>&#39;static</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>str</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>match</span><span style=background-color:#eff1f5;color:#4f5b66> repo.</span><span style=background-color:#eff1f5;color:#96b5b4>read</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>id</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>Some</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Ok</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>Redirect::</span><span style=background-color:#eff1f5;color:#4f5b66>permanent</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>_</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>=&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Err</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>Requested ID was not found.</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#[post(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>, data = </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>&lt;url_form&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>)]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>shorten</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>repo</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>State</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>RwLock</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>Repository</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>, </span><span style=background-color:#eff1f5;color:#bf616a>url_form</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Form</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>Url</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Result</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>String, String</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>ref</span><span style=background-color:#eff1f5;color:#4f5b66> url </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> url_form.</span><span style=background-color:#eff1f5;color:#96b5b4>get</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.url</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> repo </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> repo.</span><span style=background-color:#eff1f5;color:#96b5b4>write</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> id </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> repo.</span><span style=background-color:#eff1f5;color:#96b5b4>store</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>url</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>Ok</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>id.</span><span style=background-color:#eff1f5;color:#96b5b4>to_string</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>main</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>rocket::</span><span style=background-color:#eff1f5;color:#4f5b66>ignite</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>manage</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>RwLock::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>Repository::</span><span style=background-color:#eff1f5;color:#4f5b66>new</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>mount</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>/</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>routes!</span><span style=background-color:#eff1f5;color:#4f5b66>[</span><span style=background-color:#eff1f5;color:#4f5b66>lookup</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> shorten</span><span style=background-color:#eff1f5;color:#4f5b66>]</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                    </span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>launch</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>As you can see we're using a <a target=_blank rel=noopener href=https://doc.rust-lang.org/std/sync/struct.RwLock.html>std::sync::RwLock</a> here, to protect our repository from shared mutable access. This type of lock allows any number of readers or at most one writer at the same time.
It makes our code a bit harder to read because whenever we want to access our repository, we need to call the <a target=_blank rel=noopener href=https://doc.rust-lang.org/std/sync/struct.RwLock.html#method.read>read</a> and <a target=_blank rel=noopener href=https://doc.rust-lang.org/std/sync/struct.RwLock.html#method.write>write</a> methods first.<p>In our <code>lookup</code> method, you can see that we are returning a <a target=_blank rel=noopener href=https://doc.rust-lang.org/std/result/enum.Result.html>Result</a> type now. It has two cases: if we find an id in our repository, we return <code>Ok(Redirect::permanent(url))</code>, which will take care of the redirect. If we can't find the id, we return an <code>Error</code>.<p>In our <code>shorten</code> method, we switched from a <code>get</code> to a <code>post</code> request.
The advantage is, that we don't need to deal with URL encoding. We just create a struct <code>Url</code> and derive <a target=_blank rel=noopener href=https://rocket.rs/guide/requests/#data>FromForm</a> for it, which will handle the deserialization for us. Fancy!<p>We're done. Let's fire up the service again and try it out!<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>cargo run
</span></pre><p>In a new window, we can now store our first URL:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>curl --data &quot;url=https://www.matthias-endler.de&quot; http://localhost:8000/
</span></pre><p>We get some ID back that we can use to retrieve the URL again. In my case, this was <code>gY</code>.
Go to your browser and request it: <a target=_blank rel=noopener href=http://localhost:8000/gY>http://localhost:8000/gY</a>
You should be redirected to my homepage.<h3>Summary</h3><p>Rocket provides fantastic documentation and a great community.
It really feels like an idiomatic Rustlang web framework.<p>I hope you had some fun while playing with Rocket.<br>You can <a target=_blank rel=noopener href=https://github.com/mre/rustly>find the full example code on Github</a>.<ul class=links><li>💬 Comments available on
<a target=_blank rel=noopener href=https://www.reddit.com/r/programming/comments/64li3l/launching_a_url_shortener_in_rust_using_rocket/>Reddit</a>
and
<a target=_blank rel=noopener href=https://twitter.com/matthiasendler/status/851128136624480256>Twitter</a>.</ul></main><footer><form style="border:1px solid #ccc;padding:30px;text-align:center" action=https://tinyletter.com/mre method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/mre','popupwindow','scrollbars=yes,width=800,height=600');return true"><p><label for=tlemail>Subscribe to newsletter <i style=color:#aaa>(one mail per month)</i></label><p><input class="field email" type=email name=email id=tlemail placeholder="E-Mail Address">
<input type=hidden value=1 name=embed><input class="field submit" type=submit value=Subscribe><p>💡 I also <a target=_blank rel=noopener href=https://twitter.com/matthiasendler>tweet</a> new articles and have an <a target=_blank rel=noopener href=https://feedly.com/i/subscription/feed/https://matthias-endler.de/rss.xml>RSS feed</a>.</form><h3>Continue reading</h3><ul><li><a href=/2018/cargo-inspect>cargo-inspect</a><li><a href=/2018/excel>The Unreasonable Effectiveness of Excel Macros</a><li><a href=/2018/keyboard>Switching from a German to a US Keyboard Layout - Is It Worth It?</a><li><a href=/2018/fastcat>fastcat - A Faster `cat` Implementation Using Splice</a><li><a href=/2018/github>That Octocat on the Wall</a></ul></footer><script>if(location.hostname!=="localhost"&&location.hostname!=="127.0.0.1"){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-693428-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script>