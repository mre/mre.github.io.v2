<!doctype html><html lang=en><style>﻿html,body,div,form,fieldset,legend,label,h1{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0}th,td{text-align:left;vertical-align:top}h1,h2,h3,h4,h5,h6,th,td,caption{font-weight:400}img{border:0;max-width:100%}h1{font-size:1.87em}h2{font-size:1.2em;margin-bottom:10px;margin-top:0}h3{margin-top:50px}body{background-color:#fff;color:rgba(0,0,0,.8);font-family:medium-content-serif-font,Georgia,Cambria,times new roman,Times,serif;-moz-font-feature-settings:"liga" on;font-feature-settings:"liga" on;font-size:1.25em;-moz-osx-font-smoothing:grayscale;font-style:normal;font-weight:400;letter-spacing:-.003em;line-height:1.58;text-rendering:optimizeLegibility}article{margin-top:44px}pre{-moz-font-feature-settings:"liga" off;font-feature-settings:"liga" off;font-size:.92em;-moz-osx-font-smoothing:auto;-webkit-font-smoothing:subpixel-antialiased;padding:20px;overflow:auto}::-moz-selection{background:#000;color:#fff}::selection{background:#000;color:#fff}body{margin-top:8%}header{font-size:.78em;margin:0 auto 2em;max-width:220px;text-align:center}a:link,a:visited,a:hover,a:active{color:#af403c;text-decoration:none}a:hover{text-decoration:underline}nav{text-align:center}nav ul{display:inline-block;text-align:initial;padding-left:0}nav li:not(:first-child):before{content:" · "}nav li{list-style:none;display:inline}.logo{background-size:cover;display:inline-block;height:150px;width:171px}.published-date{color:#888;font-size:.8em}blockquote{border-left:4px solid #ededee;font-style:italic;margin:4px 10px;padding:3px 20px}code{background-color:#f9f9fa;border:1px solid #ededee;border-radius:6px;display:inline-block;font-family:courier new,courier,monospace;-moz-font-feature-settings:"liga" off;font-feature-settings:"liga" off;font-size:16px;-moz-osx-font-smoothing:auto;-webkit-font-smoothing:subpixel-antialiased;max-width:100%;overflow-x:auto;padding:0 5px;vertical-align:middle;word-wrap:normal;box-shadow:0 1px 1px rgba(0,0,0,.125)}.button{background-color:#af403c;border-radius:10px;color:#fff;margin:40px auto;padding:10px;text-align:center}.button:hover{background-color:red}.talk{margin-top:80px}.video-container{position:relative;padding-bottom:56.25%;padding-top:30px;height:0;overflow:hidden;margin-bottom:40px}.video-container iframe,.video-container object,.video-container embed{position:absolute;top:0;left:0;width:100%;height:100%}figure{font-size:.9em;font-style:italic;margin:0 0 40px;padding:0;text-align:center;text-indent:0}figcaption{margin-top:10px}.loader{position:relative;overflow:hidden;width:auto}.loader object{position:absolute}.loader img,.loader object{display:block;top:0;left:0;width:100%}object{position:relative;float:left;display:block}object::after{position:absolute;top:0;left:0;display:block;width:1e3px;height:1e3px;content:"";background:#efefef}.frozen{-webkit-filter:blur(8px);-moz-filter:blur(8px);-o-filter:blur(8px);-ms-filter:blur(8px);filter:blur(8px);transform:scale(1.04);animation:.2s ease-in .4s 1 forwards fade;width:100%}@keyframes fade{0%{opacity:1}100%{opacity:0}}@media(max-width:520px){body{padding:0 20px}pre{font-size:.85em;padding:5px}h1{font-size:1.6em}}@media(min-width:520px){body{margin:10% auto 0;margin-top:120px;width:480px}h1{font-size:1.6em}}@media(min-width:1024px){body{width:850px}header{float:left;width:210px}main,footer{margin-left:260px;margin-bottom:40px}}footer{margin-bottom:40px}.links{list-style:none;display:inline}.field{padding:10px;font-size:.8em}.email{width:300px}.submit{border:0;padding:12px;background-color:#eee}</style><link rel=dns-prefetch href=//www.google-analytics.com/><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=m2llJQPQq8"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=m2llJQPQq8"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=m2llJQPQq8"><link rel=manifest href="data:application/manifest+json;base64,eyJzaG9ydF9uYW1lIjoiRW5kbGVyIiwiaWNvbnMiOlt7InNyYyI6Ii9hbmRyb2lkLWNocm9tZS0xOTJ4MTkyLnBuZz92PW0ybGxKUVBRcTgiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiIvYW5kcm9pZC1jaHJvbWUtNTEyeDUxMi5wbmc/dj1tMmxsSlFQUXE4Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0="><link rel=mask-icon href="/safari-pinned-tab.svg?v=m2llJQPQq8" color=#5bbad5><link rel="shortcut icon" href="/favicon.ico?v=m2llJQPQq8"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#ffffff><meta property=og:title content="fastcat - A Faster `cat` Implementation Using Splice"><meta property=og:type content=website><meta property=og:description content="Lots of people asked me to write another piece ..."><meta property=og:url content=https://matthias-endler.de/2018/fastcat><meta property=og:image content=https://matthias-endler.de/img/social/2018_fastcat.png><meta name=twitter:title content="fastcat - A Faster `cat` Implementation Using Splice"><meta name=twitter:description content="Lots of people asked me to write another piece ..."><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@matthiasendler><meta name=twitter:creator content=@matthiasendler><meta name=twitter:image content=https://matthias-endler.de/img/social/2018_fastcat.png><title>fastcat - A Faster `cat` Implementation Using Splice | Matthias Endler</title><meta name=author content="Matthias Endler"><meta name=description content="Personal website of Matthias Endler, a Software Engineer interested in low-level programming and backend development. PHP, Python, Go, Rust."><header><a class=logo href=/><img alt=Home src=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3OTAuMjMgNjkyLjYxIj48Y2lyY2xlIGN4PSI0MTMuMjQiIGN5PSIyMjcuNyIgcj0iMjE5LjY4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMTYuMDMiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCIvPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgc3Ryb2tlPSIjYTE2MjAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCI+PHBhdGggZmlsbD0iIzMzMWYwMCIgc3Ryb2tlLXdpZHRoPSIxLjk3IiBkPSJNNDgzLjc1IDI2NS43NGwtNjcuMDcgNDAuMTQtNzQuMjMtMzkuNTMgMTQxLjMtLjZ6IiBzdHlsZT0ibGluZS1oZWlnaHQ6MTI1JSIvPjxwYXRoIGZpbGw9IiNlZmJhMDAiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTQ4Ni42NSAyNjUuOTJsLTcwLjIgMzQuMDItNzYuOS0zMy45IDE0Ny4xLS4xMnoiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIi8+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2OC42NCAyLjkxNCkgc2NhbGUoLjY1Nzk1KSIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIj48ZWxsaXBzZSBjeD0iLTYwOC43NSIgY3k9Ii0xNjMuMTQiIHRyYW5zZm9ybT0ibWF0cml4KDEuMjQ4OTcgLS4xMTM3IC4xMDcgMS4xNzUxNyAxMDk1Ljg3IDQ2Ni43KSIgcng9IjI1LjI1IiByeT0iMjgiLz48ZWxsaXBzZSBjeD0iMzMxLjM2IiBjeT0iMzQ3Ljk5IiBmaWxsPSIjZmZmIiB0cmFuc2Zvcm09Im1hdHJpeCguNTIyMTMgMCAwIC41NDc0NSAxNTguNzU3IDEzNi40MzIpIiByeD0iMTUuMTUiIHJ5PSIxNy4wNCIvPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjguNjQgMi45MTQpIHNjYWxlKC42NTc5NSkiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCI+PGVsbGlwc2UgY3g9Ii02MDguNzUiIGN5PSItMTYzLjE0IiB0cmFuc2Zvcm09Im1hdHJpeCgxLjI0ODk3IC0uMTEzNyAuMTA3IDEuMTc1MTcgMTIwMy4yIDQ2Ny42NDYpIiByeD0iMjUuMjUiIHJ5PSIyOCIvPjxlbGxpcHNlIGN4PSIzMzEuMzYiIGN5PSIzNDcuOTkiIGZpbGw9IiNmZmYiIHRyYW5zZm9ybT0ibWF0cml4KC41MjIxMyAwIDAgLjU0NzQ1IDI2NS4zNTggMTM2Ljk5MykiIHJ4PSIxNS4xNSIgcnk9IjE3LjA0Ii8+PC9nPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgc3Ryb2tlPSIjMDAwIj48cGF0aCBkPSJNMzY2LjQgMTAwLjY0YzE4LjU0LTExLjA1IDM2LjU0LTIyLjU3IDQ2Ljk0LTQwLjczIDEuMzUgMTIuMy0uMSAyOC41LTEwLjg2IDQzLjUiLz48cGF0aCBkPSJNMzg5LjQ0IDEwMC42NGMxOC41NC0xMS4wNSAzNi41NC0yMi41NyA0Ni45NC00MC43MyAxLjM1IDEyLjMtLjEgMjguNS0xMC44NiA0My41Ii8+PHBhdGggZD0iTTQxMi40OCAxMDAuNjRDNDMxLjAyIDg5LjYgNDQ5IDc4LjA3IDQ1OS40MiA1OS45YzEuMzUgMTIuMy0uMSAyOC40NC0xMC44NiA0My40NiIvPjwvZz48cGF0aCBkPSJNNDA5LjI0IDg3LjA1Yy04MS44NS4yNy0xNTYuNDQgMTA0LjQzLTE4MC40OCAyMTYuNDZhMTk5LjYgMTk5LjYuMCAwIDAgNTEuODMgNzMuMWM3LjktMTU3LjkgNDQuNy0yNjYuOSAxMTIuNS0yMDcuOCAxMC4xIDguOSAxNS4yIDEyLjkgMjAuMSAxMi42IDQuOS4zIDEwLTMuOCAyMC4xLTEyLjYgNjcuNy01OS4xIDEwNC42IDUwIDExMi41IDIwNy44YTE5OS42IDE5OS42LjAgMCAwIDUxLjgtNzIuOWMtMjQtMTEyLTk4LjYtMjE2LjMtMTgwLjUtMjE2LjUtMS4zOC4wLTIuNy4xLTQgLjEtMS4zOC4wLTIuNy0uMS00LS4xeiIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0iIzk1OTU5NSIgZD0iTTEzMS4zIDY5Mi42aDExLjRsLTIwLjkyLTEzOC4zSDEwOS41TDg4LjYgNjkyLjZIMWUybDUuODgtNDUuOGgxOS4zNnptLTI0LjItNTQuOTYgOC40Ni02NC4zIDguNDcgNjQuM3ptODIuMDUtODMuMzRIMTQ4djEwLjczaDE0Ljg3VjY5Mi42aDExLjRWNTY1LjA0aDE0Ljg4eiIgc3R5bGU9ImxpbmUtaGVpZ2h0OjEyNSU7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjonRXZlciBBZnRlciwgTm9ybWFsJzt0ZXh0LWFsaWduOnN0YXJ0IiBmb250LWZhbWlseT0iRXZlciBBZnRlciIgbGV0dGVyLXNwYWNpbmc9IjAiIHdvcmQtc3BhY2luZz0iMCIvPjxwYXRoIGZpbGw9IiM5NTk1OTUiIGQ9Ik0yMjguNjUgNTU0LjNIMTg3LjV2MTAuNzNoMTQuODdWNjkyLjZoMTEuNFY1NjUuMDRoMTQuODh6bTQ0LjkuMHY2MS4zOEgyNDUuMlY1NTQuM2gtMTEuNDJ2MTM4LjNoMTEuNHYtNjYuMzhoMjguMzZ2NjYuNGgxMS4yM1Y1NTQuM3ptMzcuOCAxMzguM2gtMTEuNFY1NTQuM2gxMS40em01Ny42NS4waDExLjRsLTIwLjkyLTEzOC4zSDM0Ny4ybC0yMC45IDEzOC4zaDExLjRsNS44Ny00NS44aDE5LjM2em0tMjQuMjItNTQuOTYgOC40Ny02NC4zIDguNDcgNjQuM3oiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246J0V2ZXIgQWZ0ZXIsIE5vcm1hbCc7dGV4dC1hbGlnbjpzdGFydCIgZm9udC1mYW1pbHk9IkV2ZXIgQWZ0ZXIiIGxldHRlci1zcGFjaW5nPSIwIiB3b3JkLXNwYWNpbmc9IjAiLz48cGF0aCBkPSJNNTE3LjI2IDU2NS4wM1Y1NTQuM2gtMzEuNjR2MTM4LjNoMzEuNjR2LTEwLjdoLTIwLjIzdi01NS43aDE4Ljg1di0xMC41NGgtMTguODVWNTY1em0xMS4yNC0xMC43M3YxMzguM2gxMS4zNVY1NTQuM0g1MjguNXptMzkuNzYuMHY1MS44N2wtLjEtLjE3djIwLjc1bC4xLjE3djY1LjdoMTEuMjRWNTU0LjNoLTExLjI0em00MC4yNC4waC0xMy44djEzOC4zaDEzLjgzcTIyLjMuMCAyOS41Ny0yMi40NiA0LjE1LTEzLjMyIDQuMTUtNDYuNjh0LTQuMTUtNDYuNjdxLTcuMjYtMjIuNS0yOS41Ni0yMi41em0tMS4yIDEyNy42aC0xLjJWNTY1LjAyaDEuMnExNS43My4wIDIwLjU3IDE4LjUgMy4xIDExLjA2IDMuMSAzOS45My4wIDI4Ljg3LTMuMSAzOS45My00Ljg0IDE4LjUtMjAuNTcgMTguNXptNjAuMjQuMFY1NTQuM2gtMTEuNHYxMzguM2gzMS42MnYtMTAuN3ptNjIuMS0xMTYuODdWNTU0LjNINjk4djEzOC4zaDMxLjYzdi0xMC43SDcwOS40di01NS43aDE4Ljg1di0xMC41NEg3MDkuNFY1NjV6bTYwLjUgMTI3LjU3cS0xNC4xNy0zNy0yMC43NC03Mi4yNSAxNC4xNy0xMC4zNyAxNC4xNy0zMy44OC4wLTMyLjE2LTI3LjQ4LTMyLjE2aC0xNS4zdjEzOC4zaDExLjR2LTY1cTIuMi0uNSA2LjktMiA3IDMzLjQgMTguMyA2Ny4xem0tMzcuODYtNzguNDd2LTQ5LjFoMi42cTEwLjU0LjAgMTQuNyA1Ljg4IDMuMjcgNC43IDMuMjcgMTUuNi4wIDE1LjgtOC4xMiAyMy40LTUuMiA0LjktMTAuMiA0LjktMS4zOC4wLTIuMjUtLjV6IiBzdHlsZT0ibGluZS1oZWlnaHQ6MTI1JTstaW5rc2NhcGUtZm9udC1zcGVjaWZpY2F0aW9uOidFdmVyIEFmdGVyLCBOb3JtYWwnO3RleHQtYWxpZ246c3RhcnQiIGZvbnQtZmFtaWx5PSJFdmVyIEFmdGVyIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEwIiBkPSJNNTM1LjA2IDU1NS43MmwzOCAxMzUuNTQiLz48cGF0aCBmaWxsPSIjOTU5NTk1IiBkPSJNLjEgNTU0LjZ2MTM4aDExLjM4VjU3NS42NWM2LjYgMTIuNyAxMy43OCAyNS45IDE5LjY3IDM2Ljc4bDUuNyAxMCAuMDItLjAydi4xbDUuNzItMTBjNi41LTEyIDEzLjUtMjUuMiAxOS43LTM2Ljh2MTE2LjloMTEuMnYtMTM4SDYyLjNDNTUgNTY4IDQ3LjUgNTgyIDQwLjggNTk0LjRsLTQgNy40NWMtOS4xLTE3LjA1LTE3LjMtMzIuMDctMjUuNC00Ny4yM3oiIHN0eWxlPSJsaW5lLWhlaWdodDoxMjUlOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246J0V2ZXIgQWZ0ZXIsIE5vcm1hbCc7dGV4dC1hbGlnbjpzdGFydCIgZm9udC1zaXplPSIxNzIuNTIiIGZvbnQtZmFtaWx5PSJFdmVyIEFmdGVyIiBsZXR0ZXItc3BhY2luZz0iMCIgd29yZC1zcGFjaW5nPSIwIi8+PHBhdGggZmlsbD0iIzk1OTU5NSIgZD0iTTM5OC44NCA2OTEuNjZjLTMuNzItMS4zMy04Ljk2LTUtMTEuNzYtOC4yLTEuNC0xLjYtMi41LTMuMjUtMi41NC0zLjYgNC4yMy02LjA1IDQuNDItNi4zMiA1LjMtNy40NSAzLjMgMy40IDYuNyA2LjggMTAuOSA5LjEgNC45OCAxLjggMTEuMjQgMi4xIDE1LjMyLS4zIDUuNTItMy4zIDguNjItOC44IDkuNjctMTcuMyAxLjQ2LTExLjctMi42NS0yMi41LTEzLjI1LTM0LjgtMi45LTMuNC03LjEzLTguMy05LjM4LTEwLjktNC44Ni01LjYtMTAtMTMuNC0xMS43Ny0xOC41LTQuMy0xMi41LTMuODctMjEuMy0uNjYtMzAuMiAyLjEyLTUuODMgNC45LTkuNiA5LjA4LTEyLjIgOC4yNi01LjE0IDE5LjI4LTQuMjQgMjcuMzYgMi4yNS45LjY4IDEuNyAxLjQ0IDIuNSAyLjU3LS40Ljc3LTMuNyA4Ljc3LTQuMyA4Ljc3LS44LS42Ni0uOC0uNi0xLjYtMS4zLS43LS43LTIuNy0yLjEtNC40LTMuMTQtNC40LTIuMS04LjUtMy4xLTEyLjktLjctNi4xIDMuNDQtOS4yIDExLjctNy45IDIxLjQgMS4xIDguMzQgNC41IDE0IDE3LjkgMjkuNSAxMy4wOCAxNS4yIDE2Ljk1IDIyLjMgMTguOSAzNC42My45IDUuNy45IDEwLjA0LjAgMTYuNi0xLjY1IDEyLjMzLTcuMiAyMC41LTE2LjIgMjMuOTYtMy4zIDEuMy0xNi40NSAxLjMtMjAuMDMuMDR6Ii8+PC9zdmc+></a><p>Backend Engineer at trivago. Likes just-in-time compilers and hot chocolate. <a href=/about>About me.</a><nav><ul><li><a href=/>Home</a><li><a target=_blank rel=noopener href=https://twitter.com/matthiasendler>Twitter</a><li><a target=_blank rel=noopener href=https://feedly.com/i/subscription/feed/https://matthias-endler.de/rss.xml>RSS</a></ul></nav></header><main role=main><div class=published-date><i>Published on 31st of July 2018</i></div><h1>fastcat - A Faster `cat` Implementation Using Splice</h1><p><img src=/img/posts/2018/fastcat/fastcat.svg alt="fastcat logo"><p>Lots of people asked me to write another piece about the internals of well-known
Unix commands. Well, actually, nobody asked me, but it makes for a good
intro. I'm sure you’ve read the previous parts about <a href=/2017/yes><code>yes</code></a> and
<a href=/2018/ls/><code>ls</code></a> — they are epic.<p>Anyway, today we talk about <code>cat</code>, which is used to concatenate files - or, more
commonly, abused to print a file's contents to the screen.<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#</span><span style=background-color:#eff1f5;color:#a7adba> Concatenate files, the intended purpose
</span><span style=background-color:#eff1f5;color:#b48ead>cat</span><span style=background-color:#eff1f5;color:#4f5b66> input1.txt input2.txt input3.txt </span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> output.txt
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#a7adba>#</span><span style=background-color:#eff1f5;color:#a7adba> Print file to screen, the most common use case
</span><span style=background-color:#eff1f5;color:#b48ead>cat</span><span style=background-color:#eff1f5;color:#4f5b66> myfile
</span></pre><h3>Implementing cat</h3><p>Here's a naive <code>cat</code> in Ruby:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#</span><span style=background-color:#eff1f5;color:#a7adba>!/usr/bin/env ruby
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>def</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>cat</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>args</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>  </span><span style=background-color:#eff1f5;color:#4f5b66>args</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#4f5b66>each </span><span style=background-color:#eff1f5;color:#b48ead>do</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#bf616a>arg</span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#d08770>IO</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#4f5b66>foreach</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>arg</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>do</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#bf616a>line</span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>      </span><span style=background-color:#eff1f5;color:#96b5b4>puts</span><span style=background-color:#eff1f5;color:#4f5b66> line
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>end</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>  </span><span style=background-color:#eff1f5;color:#b48ead>end</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>end</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>cat</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>ARGV</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>This program goes through each file and prints its contents line by line.
Easy peasy! But wait, how fast is this tool?<p>I quickly created a random 2 GB file for the benchmark.<p>Let's compare the speed of our naive implementation with the system one
using the awesome <a target=_blank rel=noopener href=http://www.ivarch.com/programs/pv.shtml>pv</a> (Pipe Viewer) tool.
All tests are averaged over five runs on a warm cache (file in memory).<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66># Ruby 2.5.1
</span><span style=background-color:#eff1f5;color:#4f5b66>&gt; ./rubycat myfile | pv -r &gt; /dev/null
</span><span style=background-color:#eff1f5;color:#4f5b66>[196MiB/s]
</span></pre><p>Not bad, I guess? How does it compare with my system's cat?<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>cat myfile | pv -r &gt; /dev/null
</span><span style=background-color:#eff1f5;color:#4f5b66>[1.90GiB/s]
</span></pre><p>Uh oh, <a target=_blank rel=noopener href="http://git.savannah.gnu.org/gitweb/?p=coreutils.git;a=blob;f=src/cat.c;h=3c319511c767f65d2e420b3bff8fa6197ddbb37b;hb=HEAD">GNU cat</a> is <strong>ten times faster</strong> than our little Ruby cat. 🐌<h2>Making our Ruby cat a little faster</h2><p>Our naive Ruby code can be tweaked a bit.
Turns out line buffering hurts performance in the end<sup><a href=#fn1 id=ref1>1</a></sup>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#</span><span style=background-color:#eff1f5;color:#a7adba>!/usr/bin/env ruby
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>def</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>cat</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>args</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>  </span><span style=background-color:#eff1f5;color:#4f5b66>args</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#4f5b66>each </span><span style=background-color:#eff1f5;color:#b48ead>do</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#bf616a>arg</span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#d08770>IO</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#4f5b66>copy_stream</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>arg</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>STDOUT</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>  </span><span style=background-color:#eff1f5;color:#b48ead>end</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>end</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>cat</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#bf616a>ARGV</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>rubycat myfile | pv -r &gt; /dev/null
</span><span style=background-color:#eff1f5;color:#4f5b66>[1.81GiB/s]
</span></pre><p>Wow... we didn't really try hard, and we're already approaching the speed of a
tool that gets optimized <a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/Cat_(Unix)>since
1971</a>. 🎉<p>But before we celebrate too much, let's see if we can go even faster.<h3>Splice</h3><p>What initially motivated me to write about <code>cat</code> was <a target=_blank rel=noopener href="https://news.ycombinator.com/item?id=15455897">this comment by user
wahern on
HackerNews</a>:<blockquote><p>I'm surprised that neither GNU yes nor GNU cat uses splice(2).</blockquote><p>Could this <em>splice</em> thing make printing files even faster? — I was intrigued.<p>Splice was first introduced to the Linux Kernel in 2006, and there is a nice
<a target=_blank rel=noopener href=https://web.archive.org/web/20130305002825/http://kerneltrap.org/node/6505>summary from Linus Torvalds himself</a>,
but I prefer the description from the <a target=_blank rel=noopener href=http://man7.org/linux/man-pages/man2/splice.2.html>manpage</a>:<blockquote><p><strong>splice()</strong> moves data between two file descriptors without copying
between kernel address space and user address space. It transfers up
to len bytes of data from the file descriptor fd_in to the file
descriptor fd_out, where one of the file descriptors must refer to a
pipe.</blockquote><p>If you really want to dig deeper, here's the corresponding <a target=_blank rel=noopener href=https://github.com/torvalds/linux/blob/6ed0529fef09f50ef41d396cb55c5519e4936b16/fs/splice.c>source code from the
Linux Kernel</a>,
but we don't need to know all the nitty-gritty details for now.
Instead, we can just inspect the <a target=_blank rel=noopener href=http://www.sourcexr.com/articles/2014/02/23/avoid-data-copy-with-splice>header from the C implementation</a>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>#include</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#a3be8c>fcntl.h</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>ssize_t</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>splice </span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#b48ead>int</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>fd_in</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> loff_t </span><span style=background-color:#eff1f5;color:#4f5b66>*</span><span style=background-color:#eff1f5;color:#bf616a>off_in</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>int</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>fd_out</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>loff_t </span><span style=background-color:#eff1f5;color:#4f5b66>*</span><span style=background-color:#eff1f5;color:#bf616a>off_out</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>size_t</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>len</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#b48ead>unsigned</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>int</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>flags</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>To break it down even more, here's how we would copy the entire <code>src</code> file to <code>dst</code>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>const</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>ssize_t</span><span style=background-color:#eff1f5;color:#4f5b66> r </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#bf616a>splice</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>src</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>NULL</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> dst</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>NULL</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> size</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>0</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>The cool thing about this is that all of it happens inside the Linux kernel, which means we won't copy a single byte to userspace (where our program runs).
Ideally, splice works by remapping pages and does not actually copy
any data, which may improve I/O performance
(<a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/Splice_(system_call)>reference</a>).<figure><img src=/img/posts/2018/fastcat/buffers.png><figcaption>File icon by Aleksandr Vector from the Noun Project.<br>terminal icon by useiconic.com from the Noun Project.</figcaption></figure><h3>Using splice from Rust</h3><p>I have to say I'm not a C programmer and I prefer Rust because it offers a safer
interface. <a target=_blank rel=noopener href=https://github.com/nix-rust/nix/blob/ebf75050f2f2726808308f76253f27c97aa6db15/src/fcntl.rs#L320-L329>Here's the same thing in Rust</a>:<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#[cfg(any(target_os = </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>linux</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>, target_os = </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>android</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a7adba>))]</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>pub</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>splice</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>fd_in</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> RawFd,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>off_in</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Option</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>libc::</span><span style=background-color:#eff1f5;color:#4f5b66>loff_t</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>fd_out</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> RawFd,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>off_out</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Option</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#b48ead>mut</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>libc::</span><span style=background-color:#eff1f5;color:#4f5b66>loff_t</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>len</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>usize</span><span style=background-color:#eff1f5;color:#4f5b66>,
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#bf616a>flags</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> SpliceFFlags,
</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>-&gt;</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>Result</span><span style=background-color:#eff1f5;color:#4f5b66>&lt;</span><span style=background-color:#eff1f5;color:#b48ead>usize</span><span style=background-color:#eff1f5;color:#4f5b66>&gt;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>Now I didn't implement the Linux bindings myself. Instead, I just used a library called
<a target=_blank rel=noopener href=https://github.com/nix-rust/nix>nix</a>, which provides Rust friendly bindings to *nix APIs.<p>There is one caveat, though:
We cannot really copy the file directly to standard out, because splice
requires one file descriptor to be a pipe.
The way around that is to create a pipe, which consists of a reader and a
writer (<code>rd</code> and <code>wr</code>).
We pipe the file into the writer, and then we read from the pipe and push the data to stdout.<p>You can see that I use a relatively big buffer of 16384 bytes (2<sup>14</sup>) to improve performance.<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>extern</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>crate</span><span style=background-color:#eff1f5;color:#4f5b66> nix</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>env</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>fs::</span><span style=background-color:#eff1f5;color:#4f5b66>File</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>io</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>std::</span><span style=background-color:#eff1f5;color:#4f5b66>os::</span><span style=background-color:#eff1f5;color:#4f5b66>unix::</span><span style=background-color:#eff1f5;color:#4f5b66>io::</span><span style=background-color:#eff1f5;color:#4f5b66>AsRawFd</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>nix::</span><span style=background-color:#eff1f5;color:#4f5b66>fcntl::</span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>splice</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> SpliceFFlags</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>use</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>nix::</span><span style=background-color:#eff1f5;color:#4f5b66>unistd::</span><span style=background-color:#eff1f5;color:#4f5b66>pipe</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>const</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>BUF_SIZE</span><span style=background-color:#eff1f5;color:#4f5b66>:</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>usize</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>16384</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#b48ead>fn</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#8fa1b3>main</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#b48ead>for</span><span style=background-color:#eff1f5;color:#4f5b66> path </span><span style=background-color:#eff1f5;color:#4f5b66>in</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>env::</span><span style=background-color:#eff1f5;color:#4f5b66>args</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>skip</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#d08770>1</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> input </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>File::</span><span style=background-color:#eff1f5;color:#4f5b66>open</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>path</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>expect</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&amp;</span><span style=background-color:#eff1f5;color:#4f5b66>format!</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>fcat: </span><span style=background-color:#eff1f5;color:#d08770>{}</span><span style=background-color:#eff1f5;color:#a3be8c>: No such file or directory</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> path</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>rd</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66> wr</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#96b5b4>pipe</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> stdout </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>io::</span><span style=background-color:#eff1f5;color:#4f5b66>stdout</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> _handle </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> stdout.</span><span style=background-color:#eff1f5;color:#96b5b4>lock</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#b48ead>loop</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> res </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#96b5b4>splice</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>input.</span><span style=background-color:#eff1f5;color:#96b5b4>as_raw_fd</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>None</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>wr</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>None</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#d08770>BUF_SIZE</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>SpliceFFlags::</span><span style=background-color:#eff1f5;color:#4f5b66>empty</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#b48ead>if</span><span style=background-color:#eff1f5;color:#4f5b66> res </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#d08770>0</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>{</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#a7adba>//</span><span style=background-color:#eff1f5;color:#a7adba> We read 0 bytes from the input,
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#a7adba>//</span><span style=background-color:#eff1f5;color:#a7adba> which means we&#39;re done copying.
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#b48ead>break</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#b48ead>let</span><span style=background-color:#eff1f5;color:#4f5b66> _res </span><span style=background-color:#eff1f5;color:#4f5b66>=</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#96b5b4>splice</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>rd</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>None</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>stdout.</span><span style=background-color:#eff1f5;color:#96b5b4>as_raw_fd</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>None</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#d08770>BUF_SIZE</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>                </span><span style=background-color:#eff1f5;color:#4f5b66>SpliceFFlags::</span><span style=background-color:#eff1f5;color:#4f5b66>empty</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>,</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>            </span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>.</span><span style=background-color:#eff1f5;color:#96b5b4>unwrap</span><span style=background-color:#eff1f5;color:#4f5b66>(</span><span style=background-color:#eff1f5;color:#4f5b66>)</span><span style=background-color:#eff1f5;color:#4f5b66>;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>        </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>    </span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span><span style=background-color:#eff1f5;color:#4f5b66>}</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>So, how fast is this?<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#4f5b66>fcat myfile | pv -r &gt; /dev/null
</span><span style=background-color:#eff1f5;color:#4f5b66>[5.90GiB/s]
</span></pre><p>Holy guacamole. That's <strong>over three times as fast as system cat</strong>.<h3>Operating System support</h3><ul><li><strong>Linux</strong> and <strong>Android</strong> are fully supported.<li><strong><a target=_blank rel=noopener href="https://stackoverflow.com/questions/12230316/do-other-operating-systems-implement-the-linux-system-call-splice?lq=1">OpenBSD</a></strong>
also has some sort of splice implementation called
<a target=_blank rel=noopener href=http://man.openbsd.org/sosplice><code>sosplice</code></a>. I haven't tested that, though.<li>On <strong>macOS</strong>, the closest thing to splice is its bigger brother,
<a target=_blank rel=noopener href=https://www.unix.com/man-page/osx/2/sendfile/>sendfile</a>, which can send a
file to a socket within the Kernel. Unfortunately, it does not support sending
from file to file.<sup><a href=#fn2 id=ref2>2</a></sup> There's also
<a target=_blank rel=noopener href=https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man3/copyfile.3.html><code>copyfile</code></a>,
which has a similar interface, but unfortunately, it is not zero-copy. (I
thought so in the beginning, but <a target=_blank rel=noopener href=https://github.com/rust-lang/libc/pull/886>I was
wrong</a>.)<li><strong>Windows</strong> doesn't provide zero-copy file-to-file transfer
(only file-to-socket transfer using the <a target=_blank rel=noopener href=https://docs.microsoft.com/en-us/windows/desktop/api/mswsock/nf-mswsock-transmitfile>TransmitFile API</a>).</ul><p>Nevertheless, in a production-grade
implementation, the splice support could be activated on systems that support
it, while using a generic implementation as a fallback.<h3>Nice, but why on earth would I want that?</h3><p>I have no idea. Probably you don't, because your bottleneck is somewhere else.
That said, many people use <code>cat</code> for piping data into another process like<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#a7adba>#</span><span style=background-color:#eff1f5;color:#a7adba> Count all lines in C files
</span><span style=background-color:#eff1f5;color:#b48ead>cat</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>*</span><span style=background-color:#eff1f5;color:#4f5b66>.c </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>wc</span><span style=background-color:#eff1f5;color:#4f5b66> -l
</span></pre><p>or<pre style=background-color:#eff1f5>
<span style=background-color:#eff1f5;color:#b48ead>cat</span><span style=background-color:#eff1f5;color:#4f5b66> kittens.txt </span><span style=background-color:#eff1f5;color:#4f5b66>|</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#b48ead>grep</span><span style=background-color:#eff1f5;color:#4f5b66> </span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#a3be8c>dog</span><span style=background-color:#eff1f5;color:#4f5b66>&quot;</span><span style=background-color:#eff1f5;color:#4f5b66>
</span></pre><p>In this case, if you notice that <code>cat</code> is the bottleneck try <code>fcat</code> (but first,
<a target=_blank rel=noopener href=http://porkmail.org/era/unix/award.html>try to avoid <code>cat</code> altogether</a>).<p>With some more work, <code>fcat</code> could also be used to directly route packets from one
network card to another, <a target=_blank rel=noopener href=http://nc110.sourceforge.net/>similar to netcat</a>.<h3>Lessons learned</h3><ul><li>The closer we get to bare metal, the more our hard-won abstractions fall
apart, and we are back to low-level systems programming.<li>Apart from a fast cat, there's also a use-case for a slow cat: old computers.
For that purpose, there's... well.. <a target=_blank rel=noopener href=https://grox.net/software/mine/slowcat/>slowcat</a>.</ul><p>That said, I still have no idea why GNU cat does not use splice on Linux. 🤔
The <a target=_blank rel=noopener href=https://github.com/mre/fcat>source code for fcat is on Github</a>.
Contributions welcome!<p><strong>Thanks</strong> to <a target=_blank rel=noopener href=https://twitter.com/hwmrocker>Olaf Gladis</a> for helping me run the benchmarks on his Linux machine and to <a target=_blank rel=noopener href=https://github.com/SHyx0rmZ>Patrick Pokatilo</a> and <a target=_blank rel=noopener href=https://github.com/m3t0r>Simon Brüggen</a> for reviewing drafts of the article.<h3>Footnotes</h3><p><sup id=fn1>1. Thanks to reader <a target=_blank rel=noopener href=https://www.reddit.com/r/rust/comments/93fbrj/fascat_a_faster_cat_implementation_using_splice/e3d2chn/>Freeky</a> for making this code more idiomatic.<a href=#ref1 title="Jump back to footnote 1 in the text.">↩</a></sup><br><sup id=fn2>2. Thanks to reader <a target=_blank rel=noopener href=https://www.reddit.com/r/rust/comments/93fbrj/fascat_a_faster_cat_implementation_using_splice/e3cu3rk/>masklinn</a> for the hint.<a href=#ref2 title="Jump back to footnote 2 in the text.">↩</a></sup><ul class=links><li>💬 Comments available on
<a target=_blank rel=noopener href=https://www.reddit.com/r/rust/comments/93fbrj/fascat_a_faster_cat_implementation_using_splice/>Reddit</a>, <a target=_blank rel=noopener href=https://lobste.rs/s/vmucxl/fastcat_faster_cat_implementation_using>Lobsters</a>
and
<a target=_blank rel=noopener href="https://news.ycombinator.com/item?id=17657485">HackerNews</a>.</ul></main><footer><form style="border:1px solid #ccc;padding:30px;text-align:center" action=https://tinyletter.com/mre method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/mre','popupwindow','scrollbars=yes,width=800,height=600');return true"><p><label for=tlemail>Subscribe to newsletter <i style=color:#aaa>(one mail per month)</i></label><p><input class="field email" type=email name=email id=tlemail placeholder="E-Mail Address">
<input type=hidden value=1 name=embed><input class="field submit" type=submit value=Subscribe><p>💡 I also <a target=_blank rel=noopener href=https://twitter.com/matthiasendler>tweet</a> new articles and have an <a target=_blank rel=noopener href=https://feedly.com/i/subscription/feed/https://matthias-endler.de/rss.xml>RSS feed</a>.</form><h3>Continue reading</h3><ul><li><a href=/2018/cargo-inspect>cargo-inspect</a><li><a href=/2018/excel>The Unreasonable Effectiveness of Excel Macros</a><li><a href=/2018/keyboard>Switching from a German to a US Keyboard Layout - Is It Worth It?</a><li><a href=/2018/github>That Octocat on the Wall</a></ul></footer><script>if(location.hostname!=="localhost"&&location.hostname!=="127.0.0.1"){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-693428-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script>